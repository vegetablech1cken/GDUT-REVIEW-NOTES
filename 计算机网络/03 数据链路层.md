# 3.1  使用点对点信道的数据链路层（循环冗余检验技术）
## 为什么需要数据链路层
- 物理层解决了相邻结点透明传输⽐特的问题
- 物理层没解决的问题：

	- **传输错误问题**：发送端发送比特 1，而接收端收到比特 0，接收端无法知道接收的是否正确
	- **接收方选择问题**：多个设备连接，谁发送谁接受
	- **传输结束问题**：如何知道一组数据即将到来，何时结束
![](assets/3.1.1.png)
![](assets/3.1.2.png)
## 3.1.1 数据链路和帧

**链路**：从一个节点到相邻节点的一段物理线路

**数据链路**：联络+实现协议的硬件和软件 or 网络适配器

**帧**：点对点信道的通信链路层的协议数据单元

## 3.1.2 三个基本问题

1. 封装成帧

- 在一段数据的前后分别添加首部和尾部，然后就构成了一个帧，确定帧的界限
- 首部和尾部的一个重要作用就是进行帧定界
  ![](assets/3.1.3.png)

2. 透明传输
- **透明传输**：无论什么样的比特组合的数据，都能够按照原样没有差错地通过这个数据链路层
- 如果数据中的某个字节的二进制代码恰好和 SOH 或 EOT 一样，数据链路层就会错误地“找到帧的边界”
  ![](assets/3.1.4.png)
- 解决方法：字节填充或字符填充
- 发送端的数据链路层在数据中出现控制字符“SOH”或“EOT”前插入一个**转义字符“ESC”**
- 若转义字符也出现在数据当中，则在转义字符前插入一个转义字符，接收到连续的转义字符时，删除前面的一个
  ![](assets/3.1.5.png)
2. 差错检测

- 循环冗余检验（Cyclic Redundancy Check, CRC）
	- 在发送端，先把数据划分成组，假定每组 k 个比特
	- 冗余码的计算
		- **原理**：通过模 2 除法（异或运算）生成冗余位，广泛应用于网络通信和存储系统。
		- **计算步骤**：
			- **约定生成多项式**（如 CRC-32 的 `G(x) = x³² + x²⁶ + x²³ + x²² + x¹⁶ + x¹² + x¹¹ + x¹⁰ + x⁸ + x⁷ + x⁵ + x⁴ + x² + x + 1`）。
			- **数据左移**：在原始数据后补 `r` 个 0（`r` 是生成多项式的最高次幂）。
			- **模 2 除法**：用生成多项式对应的二进制数除扩展后的数据，余数即为冗余码（CRC 码）。
			- **附加冗余码**：将余数替换到数据末尾的 0 位置。
		- **示例**：
			- 数据：`1101011011`，生成多项式：`10011`（x⁴ + x + 1）
			- 步骤：
				- 数据左移 4 位：`11010110110000`
				- 模 2 除法求余数（过程略），得到冗余码：`1110`
				- 传输数据：`11010110111110`

## 帧检验序列（Frame Check Sequence, FCS）

- **定义与本质**

| 项目 | CRC                                     | FCS                                                               |
| ---- | --------------------------------------- | ----------------------------------------------------------------- |
| 全称 | Cyclic Redundancy Check（循环冗余校验） | Frame Check Sequence（帧检验序列）                                |
| 本质 | 一种**错误检测的算法或方法**            | 一个**附加在数据帧尾部的字段或值**（通常是 CRC 计算得出的冗余码） |

- **功能与作用**

	- **CRC**：
		- 是一种**数学算法**，通过生成多项式对数据进行除法运算，生成校验码。
		- 用于**检测数据传输过程中是否出现比特错误**（如 0 变 1 或 1 变 0）。
		- 本身是一种**方法**，不依赖于具体帧结构。
	- **FCS**：
		- 是**数据链路层帧格式中的一个字段**（通常为 4 字节），用于存储校验码。
		- 提供**错误检测机制**，接收方通过重新计算校验码并与 FCS 字段比较，判断帧是否出错。
		- 是**CRC 算法的一种应用场景**，但理论上也可以通过其他校验方法生成。

- **关系与区别**

	- **关系**：
		- FCS**通常由 CRC 算法计算得出**，是 CRC 校验码在帧中的具体体现。
		- 例如，以太网帧的 FCS 字段就是使用 CRC-32 算法生成的 32 位校验码。
	- **区别**：
		- CRC 是**算法**，FCS 是**结果或字段**。
		- CRC 不限于网络通信，也用于存储、压缩等领域；FCS**专用于数据帧的完整性校验**。
		- CRC 只提供**检错能力**，FCS 字段的存在使得接收方可以**快速判断帧是否出错并丢弃错误帧**

- **工作流程举例**（以太网帧）

	- 发送端：
		- 对帧头+数据部分使用 CRC 算法（如 CRC-32）计算冗余码。
		- 将计算结果作为 FCS 字段附加在帧尾
	- 接收端：
		- 对接收到的帧（除 FCS 外）重新计算 CRC。
		- 将计算结果与接收到的 FCS 比较：
			- 若一致，认为帧无错，接受。
			- 若不一致，认为帧出错，丢弃
  ![](assets/3.1.6.png)

- **总结**

	- **CRC 是“方法”，FCS 是“结果”**
	- **FCS 是 CRC 在数据帧中的具体应用**，但 FCS 也可以通过其他校验算法生成
	- 在以太网等协议中，**FCS 字段就是 CRC 校验码**，用于确保帧在传输过程中的完整性
  
  ---
  
# 3.2  点对点协议 （PPP协议）
## 3.2.1 PPP 协议的特点

1. PPP 协议应满足的需求
   - **简单** —— 这是首要的要求，最复杂的部分放在TCP协议中，链路层的帧不需要纠错，不需要序号，无需流量控制，只需要进行CRC检验
   - **封装成帧** —— 必须规定特殊的字符作为帧定界符
   - **透明性** —— 必须保证数据传输的透明性
   - **支持多种网络层协议** —— 能够在同一条物理链路上同时支持多种网络层协议（如IP和IPX等）
   - **多种类型链路** —— 能够在多种类型的链路上运行，如串行或并行，同步或异步，低速或高速，电的链路或光的链路
   - **差错检测** —— 能够对接收端收到的帧进行检测，并立即丢弃有差错的帧

2. PPP 协议不需要的功能

- 纠错
- 流量
- 序号
- 多点线路
- 半双工或单工链路（也就是PPP协议只支持全双工通信链路）

## 3.2.2 PPP 协议的帧格式

![](assets/3.2.1.png)

### 1 . 各字段的意义
1. Flag（标志字段）
		固定 0 x 7 E（01111110），标识一帧的开始与结束。采用“比特填充”（发送端在连续 5 个 1 后自动插入 1 个 0）或“字符填充”（异步链路时转义）保证数据透明传输。
2. Address（地址字段）
		固定 0 xFF（11111111）。PPP 是点对点链路，不需要地址寻址，保留该字段仅为与 HDLC 兼容。
3. Control（控制字段）    
		固定 0 x 03（00000011），表示“无编号帧”（UI），即没有序号、确认和流量控制，提供无连接不可靠服务。
4. Protocol（协议字段）
		16 bit，指明 Data 字段承载的上层协议或协商子协议：
		1. 0 x 0021  IPv 4 数据报
		2. 0 x 0057  IPv 6 数据报
		3. 0 x 8021  IPCP（IP Control Protocol）
		4. 0 xC 021  LCP（Link Control Protocol）
		5. 0 xC 023  PAP
		6. 0 xC 223  CHAP
			等等。
5. Data（信息字段）
		用户数据或协议协商报文。默认最大长度 1500 B（MRU），可在 LCP 阶段协商更大或更小值。不足 MRU 时无需填充。
6. FCS（Frame Check Sequence）
		缺省 16 bit CRC（CRC-CCITT，生成多项式 x¹⁶+x¹²+x⁵+1）；LCP 可协商 32 bit CRC（CRC-32）。检验范围从 Address 到 Data 的最后一个字节。接收端计算出错则丢弃该帧，不反馈重传。
7. 结束 Flag
		与起始 Flag 相同，也为 0 x 7 E。两帧可以共用同一个 Flag（即前一帧的结束 Flag 同时作为下一帧的开始 Flag）。
		
- PPP 帧的首部和尾部分别为 4 个字段和 2 个字段
- 标志字段 F = 0x7E （符号“0x”表示后面的字符是用十六进制表示。十六进制的 7E 的二进制表示是 01111110）即帧定界符
- 地址字段 A 只置为 0xFF。地址字段实际上并不起作用
- 控制字段 C 通常置为 0x03
- PPP 是面向字节的，所有的 PPP 帧的长度都是整数字节

### 2 . 字节填充

#### 一、发送端处理规则

1. 帧首尾各插一个 Flag：0 x 7 E。
	1. 对 Address、Control、Protocol、Data、FCS 各字节逐一扫描：
		- 若字节 == 0 x 7 E → 替换成两字节序列 **0 x 7 D 0 x 5 E**
		- 若字节 == 0 x 7 D → 替换成两字节序列 **0 x 7 D 0 x 5 D**
		- 若字节值 < 0 x 20（32）且该链路“允许转义控制字符”(ACCM) 掩码对应位为 1，也转义：
			0 x 7 D + (原字节 XOR 0 x 20)
			默认 ACCM 为 0 xFFFFFFFF，即所有 0 x 00–0 x 1 F 全部转义；LCP 可协商改变 ACCM。

2. 把转义后的字节流发出；FCS 计算**在转义之前**完成。

#### 二、接收端恢复算法

1. 收到字节流后，遇到 0 x 7 E 即认为是帧边界。
	1. 扫描帧内字节：
		- 若当前字节 == 0 x 7 D → 丢弃 0 x 7 D，把下一字节 XOR 0 x 20 后作为真实数据；
		- 否则直接作为真实数据。

2. 把还原后的完整帧（含 Addr/Ctrl/Protocol/Data/FCS）交给 FCS 校验；
	校验失败则丢弃，成功则按 Protocol 字段上交网络层。

3. 零比特填充：出现 5 个连续 1 时，在后面加一个 0
   ![](assets/3.2.2.png)

## 3.2.3 PPP 协议的工作状态
- 当用户拨号接入 ISP 时，就建立了一条从用户个人电脑到ISP的物理连接
- PC 机向ISP发送一系列的 LCP（链路控制协议） 分组（封装成多个 PPP 帧）
- 这些分组及其响应选择一些 PPP 参数 (最大帧长、使用的鉴别协议)，并进行网络层配置，NCP （网络控制协议） 给新接入的 PC 机分配一个临时的 IP 地址，使 PC 机成为互联网上的一个主机
- 通信完毕时，NCP释放网络层连接，收回原来分配出去的 IP 地址。接着，LCP 释放数据链路层连接。最后释放的是物理层的连接
- **可见，PPP 协议已不是纯粹的数据链路层的协议，它还包含了物理层和网络层的内容**
![](assets/3.2.3.png)
# 3.3  使用广播信道的数据链路层协议（CSMA/CD协议）
## 3.3.1  局域网的数据链路层
- 局域网最主要的特点是
	- 网络为一个单位所拥有
	- 地理范围和站点数目均有限
- 局域网具有如下**主要优点**
	- **具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源**
	- 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变
	- 提高了系统的可靠性、可用性和残存性
- 局域网拓扑结构
	![](assets/3.3.1.png)
- 以太网中的媒体共享技术
	- **静态划分信道**（用户只要分配到信道就不会和其他用户产生冲突，这种划分信道的方法代价较高，不适用于局域网使用）
		- 频分复用
		- 时分复用
		- 波分复用
		- 码分复用
	- 动态媒体接入控制
		- **随机接入**：所有的用户可随机地发送信息，但如果有两个或更多的用户在同一时刻发送信息，在共享媒体上就会产生碰撞。因此，需要设计一种协议解决碰撞问题。（以太网使用随机接入）
		- **受控接入** ，如多点线路探询 (polling)，或轮询
1. 数据链路层的两个子层
   - 为了使数据链路层能更好地适应多种局域网标准，IEEE 802 委员会就将局域网的数据链路层拆成两个子层：
		   - 逻辑链路控制 LLC (Logical Link Control)子层；
		   - 媒体接入控制 MAC (Medium Access Control)子层
   - 与接入到传输媒体有关的内容都放在 MAC子层，而 LLC 子层则与传输媒体无关
   - 不管采用何种协议的局域网，对 LLC 子层来说都是透明的
     ![](assets/3.3.2.png)
   - 一般不考虑 LLC 子层
	   - 由于 TCP/IP 体系经常使用的局域网是 DIX Ethernet V2 而不是 802.3 标准中的几种局域网，因此现在 **802 委员会制定的逻辑链路控制子层 LLC（即 802.2 标准）的作用已经不大了**
	   - **很多厂商生产的适配器上就仅装有 MAC 协议而没有 LLC 协议**
 2. 适配器的作用
    - 将计算机连接到局域网
    - 网络接口板又称为通信适配器 (adapter) 或网络接口卡 NIC (Network Interface Card)，或“网卡”
    - 计算机通过适配器（网卡）和局域网进行通信
      ![](assets/3.3.3.png)

## 3.3.2  CSMA/CD 协议
- 最初的以太网是将许多计算机都连接到一根总线上，采用广播通信方式，也可以实现一对一通信
  ![](assets/3.3.4.png)
### 以太网采用广播方式发送
- 总线上的每一个工作的计算机都能**检测到 B 发送的数据信号**
- **为了实现⼀对⼀通信，将接收站的硬件地址写⼊帧⾸部中的⽬的地址字段中，仅当数据帧中的⽬的地址与适配器的硬件地址⼀致时，才能接收这个数据帧**
- 由于只有**计算机 D** 的地址与数据帧首部写入的**地址一致**，因此只有 D 才接收这个数据帧
- **其他所有的计算机**（A, C 和 E）都检测到不是发送给它们的数据帧，因此就**丢弃**这个数据帧而不能够收下来
- 在具有广播特性的总线上实现了**一对一的通信**
### 以太网两种重要措施
为了通信的简便，以太网采取了两种重要的措施：
1. 采用较为灵活的无连接的工作方式
   - 不必先建立连接就可以直接发送数据
   - 对发送的数据帧不进行编号，也不要求对方发回确认
   - 这样做的理由是局域网信道的质量很好，因信道质量产生差错的概率是很小的
   - 提供的服务是不可靠交付（尽最大努力的交付）
   - 当目的站收到有差错的数据帧时就丢弃此帧，其他什么也不做。**差错的纠正由高层来决定**
2. 以太网发送的数据都使用**曼彻斯特** (Manchester) 编码
   ![](assets/3.3.5.png)
### CSMA/CD协议
- CSMA/CD 含义：载波监听多点接入 / 碰撞检测  (Carrier Sense Multiple Access with Collision Detection) 
- “多点接入”表示许多计算机以多点接入的方式连接在一根总线上
- “载波监听”是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞
- 总线上并没有什么“载波”。因此， “载波监听”就是用电子技术检测总线上有没有其他计算机发送的数据信号
### 碰撞检测
- “碰撞检测”就是计算机边发送数据边检测信道上的信号电压大小
- 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）
- 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞
- 所谓“碰撞”就是发生了冲突。因此“碰撞检测”也称为“冲突检测
## 3.3.3  使用集线器的星形拓扑
## 3.3.4  以太网的信道利用率
## 3.3.5  以太网的 MAC 层
# 3.4  扩展的以太网

# 3.5  高速以太网